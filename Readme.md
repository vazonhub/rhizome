# **Техническая документация: P2P Сеть на Kademlia DHT с системой seed-узлов**

## **1. Общая архитектура системы**

### **1.1. Цели системы**

1. Создание децентрализованной анонимной сети для обмена сообщениями
2. Обеспечение доступности данных через механизмы репликации
3. Автоматическое определение и приоритезация популярного контента
4. Решение проблемы "холодного старта" новых узлов

### **1.2. Ключевые принципы**

- **Полная децентрализация**: отсутствие центральных серверов
- **Анонимность**: скрытие связей отправитель-получатель при публичном содержимом
- **Отказоустойчивость**: автоматическое восстановление при потере узлов
- **Масштабируемость**: поддержка тысяч узлов без деградации производительности

---

## **2. Сетевой протокол на базе Kademlia DHT**

### **2.1. Структура идентификаторов**

- **Node ID**: 160-битный идентификатор узла (генерируется при первом запуске)
- **Ключи данных**: SHA-256 хэш от содержимого или составного ключа
- **Дистанция**: XOR-метрика для определения близости узлов

### **2.2. Таблицы маршрутизации**

- **k-бакеты**: 160 бакетов, каждый содержит до k=20 узлов
- **Обновление бакетов**: при каждом взаимодействии с узлом
- **Lookup алгоритм**: параллельные запросы к α=3 ближайшим узлам

### **2.3. Операции DHT**

- **STORE(key, value, ttl)**: сохранение данных на k ближайших узлах
- **FIND_VALUE(key)**: поиск значения по ключу с кэшированием
- **FIND_NODE(node_id)**: поиск узлов по идентификатору
- **PING**: проверка доступности узла

### **2.4. Механизмы обеспечения живучести**

- **Рефрешинг бакетов**: периодический поиск случайных ключей
- **Replication**: повторное сохранение данных при изменении состава сети
- **Expiration**: TTL для всех данных (1 день по умолчанию, продлевается при активности)

---

## **3. Классификация узлов и их роли**

### **3.1. Типы узлов**

### **Seed-узлы (Семена)**

- **Назначение**: обеспечение начальной загрузки, долгосрочное хранение
- **Характеристики**:
    - Высокая доступность (uptime > 95%)
    - Большой объем дискового пространства (> 100 ГБ)
    - Высокая пропускная способность канала
    - Статические IP-адреса или надежный DynDNS
- **Обязанности**:
    - Хранение полных копий популярных данных
    - Репликация на другие seed-узлы
    - Обслуживание bootstrap-запросов
    - Ведение индекса всей сети

### **Full-узлы (Полные)**

- **Назначение**: основная рабочая нагрузка сети
- **Характеристики**:
    - Средняя доступность (uptime > 70%)
    - Умеренный объем диска (> 10 ГБ)
    - Активное участие в маршрутизации
- **Обязанности**:
    - Хранение данных, которые проходили через узел
    - Маршрутизация запросов
    - Кэширование популярного контента
    - Участие в репликации

### **Light-узлы (Легкие)**

- **Назначение**: клиентские узлы с ограниченными ресурсами
- **Характеристики**:
    - Низкая доступность (uptime переменный)
    - Ограниченный диск (< 1 ГБ)
    - Мобильные устройства или домашние ПК
- **Обязанности**:
    - Хранение только актуальных данных
    - Поддержка только необходимых k-бакетов
    - Зависимость от полных узлов для некоторых операций

### **Mobile-узлы (Мобильные)**

- **Назначение**: максимально легкие клиенты
- **Характеристики**:
    - Очень ограниченные ресурсы
    - Непостоянное соединение
    - Низкая пропускная способность
- **Особенности**:
    - Используют упрощенный протокол
    - Подключаются через мостовые узлы
    - Не участвуют в маршрутизации

### **3.2. Протокол определения типа узла**

1. Автоматическая классификация при запуске (анализ ресурсов)
2. Ручное назначение типа (пользовательский выбор)
3. Динамическое изменение типа при изменении условий
4. Верификация seed-узлов через proof-of-storage

---

## **4. Система данных и хранения**

### **4.1. Структура ключей DHT**

### **Глобальные индексы**

text

```
global:threads              → Список ID всех тредов
global:popular              → Топ-N популярных тредов (обновляется ежечасно)
global:recent               → Последние N сообщений (скользящее окно 24 часа)
global:seeds                → Список активных seed-узлов с их capacity
```

### **Данные тредов**

text

```
thread:{thread_id}:meta     → Метаданные треда (название, создатель, время)
thread:{thread_id}:index    → Хронологический список сообщений треда
thread:{thread_id}:popular  → Популярные сообщения в треде (по голосам)
thread:{thread_id}:stats    → Статистика (просмотры, ответы, активность)
```

### **Сообщения**

text

```
msg:{message_hash}          → Полное сообщение с метаданными
msg:{message_hash}:refs     → Ссылки на ответы/цитаты
msg:{message_hash}:votes    → Голоса/реакции к сообщению
```

### **Пользовательские данные (опционально)**

text

```
user:{pubkey}:profile       → Профиль пользователя (ник, аватар)
user:{pubkey}:threads       → Созданные пользователем треды
user:{pubkey}:reputation    → Репутация/карма
```

### **4.2. Форматы данных**

### **Метаданные треда**

text

```
{
  "id": "thread_abc123",
  "title": "Обсуждение протокола Rhizome",
  "created_at": 1678886400,
  "creator_pubkey": "0xabc...",
  "category": "технологии",
  "tags": ["p2p", "dht", "анонимность"],
  "message_count": 42,
  "last_activity": 1678886500,
  "popularity_score": 8.7,
  "encryption_type": "public",
  "access_control": null
}
```

### **Сообщение**

text

```
{
  "id": "msg_xyz789",
  "thread_id": "thread_abc123",
  "parent_id": "msg_prev456",
  "content": "Текст сообщения...",
  "author_signature": "ring_sig_...",
  "timestamp": 1678886450,
  "content_type": "text/markdown",
  "attachments": ["hash1", "hash2"],
  "metadata": {
    "client_version": "1.0",
    "user_agent": "Rhizome Desktop"
  }
}
```

### **4.3. Политики хранения**

### **TTL (Time-To-Live) по умолчанию**

- Популярные данные (score > 7.0): 30 дней
- Активные данные (score 5.0-7.0): 7 дней
- Обычные данные: 1 день
- Личные сообщения: 3 часа (для анонимности)

### **Продление TTL**

- При каждом чтении данных TTL продлевается на 10%
- При достижении порога популярности TTL увеличивается
- Seed-узлы периодически обновляют TTL для важных данных

### **Эвакуация данных**

- При нехватке места удаляются наименее популярные данные
- Seed-узлы никогда не удаляют данные из своего "обязательного набора"
- Минимальный гарантированный срок хранения: 1 час для любых данных

---

## **5. Механизм определения популярности**

### **5.1. Метрики популярности**

### **Базовые метрики (всегда доступны)**

1. **Частота запросов (request_rate)**: количество FIND_VALUE в час
2. **Распространенность (replication_count)**: на скольких узлах хранится
3. **Свежесть (freshness)**: возраст данных (новое = выше балл)
4. **Размер аудитории (audience_size)**: уникальные узлы, запрашивающие данные

### **Расширенные метрики (если доступны)**

1. **Социальные взаимодействия**: ответы, цитаты, упоминания
2. **Время просмотра**: для клиентов, которые передают эту статистику
3. **Геораспределение**: насколько широко географически распространены данные
4. **Seed-коэффициент**: какая доля seed-узлов хранит данные

### **5.2. Алгоритм подсчета рейтинга**

### **Формула популярности**

text

```
popularity_score =
  (request_rate * 0.25) +
  (replication_factor * 0.20) +
  (freshness_score * 0.15) +
  (audience_size * 0.10) +
  (social_engagements * 0.20) +
  (seed_coverage * 0.10)
```

### **Адаптивные веса**

- В начальной фазе жизни контента: выше вес свежести
- После 24 часов: выше вес социальных взаимодействий
- После 7 дней: выше вес устойчивости (seed_coverage)

### **5.3. Процесс ранжирования**

### **Локальное ранжирование (каждый узел)**

1. Сбор метрик для локально хранимых данных
2. Вычисление локального рейтинга каждый час
3. Обмен топ-100 с соседними узлами раз в 6 часов

### **Глобальное ранжирование (seed-узлы)**

1. Агрегация локальных рейтингов от всех узлов
2. Вычисление консенсусного рейтинга
3. Публикация глобального топа каждые 3 часа
4. Верификация через proof-of-activity

### **5.4. Система голосования и спам-фильтрация**

### **Механизм Sybil-устойчивого голосования**

1. Вес голоса зависит от репутации узла
2. Новые узлы имеют ограниченный вес голоса
3. Seed-узлы имеют повышенный вес
4. Автоматическое обнаружение и подавление сибил-атак

### **Анти-спам механизмы**

- Ограничение скорости публикации для новых узлов
- Анализ паттернов поведения (спам-детекция)
- Система жалоб и модерации
- Делегированная модерация через доверенные узлы

---

## **6. Система seed-узлов и репликации**

### **6.1. Инициализация seed-узла**

### **Требования к seed-узлу**

1. Минимальный uptime: 95%
2. Минимальный объем хранилища: 100 ГБ
3. Гарантированная пропускная способность: 100 Мбит/с
4. Надежная идентификация (TLS сертификат или аналоги)

### **Процесс становления seed-узлом**

1. Подача заявки с proof-of-resources
2. Верификация существующими seed-узлами
3. Период испытательного срока (7 дней)
4. Полное включение в сеть seed-узлов

### **6.2. Механизмы репликации**

### **Пассивная репликация (реактивная)**

- При запросе данных узел проверяет replication_factor
- Если factor < целевого значения, инициирует репликацию
- Репликация на случайно выбранные узлы в пределах соседства

### **Активная репликация (проактивная)**

- Seed-узлы периодически сканируют популярность данных
- Автоматическая репликация данных с высоким рейтингом
- Балансировка нагрузки между seed-узлами

### **Экстренная репликация**

- При обнаружении потери узла с уникальными данными
- Немедленная репликация с оставшихся копий
- Приоритетная обработка в очереди репликации

### **6.3. Стратегии размещения данных**

### **Географическое распределение**

- Репликация данных в разные географические регионы
- Учет задержек сети при размещении
- Предпочтение узлам с хорошей связностью

### **Избыточность и отказоустойчивость**

- Минимальный replication_factor: 5 для обычных данных
- Для популярных данных (>7.0): минимум 3 seed-узла + 7 обычных
- Гарантия доступности: данные доступны при потере до 30% узлов

### **6.4. Протокол синхронизации с seed-узлами**

### **Полная синхронизация (для новых узлов)**

1. Получение списка активных seed-узлов
2. Выбор оптимального seed-узла (по задержке и нагрузке)
3. Последовательная загрузка:
    - Сначала глобальные индексы
    - Затем топ-100 популярных тредов
    - Параллельная загрузка остальных данных
4. Верификация целостности через хэши

### **Инкрементальная синхронизация**

1. Хранение водяного знака последней синхронизации
2. Периодический опрос seed-узлов на наличие обновлений
3. Дельта-синхронизация только измененных данных
4. Фоновая синхронизация при простое

### **Partial Sync (для light-узлов)**

1. Загрузка только метаданных
2. Ленивая загрузка контента по требованию
3. Кэширование на ограниченное время
4. Приоритетная загрузка социального графа пользователя

---

## **7. Анонимность и безопасность**

### **7.1. Сокрытие отправителя/получателя**

### **Кольцевые подписи для сообщений**

- Группа из 5-10 публичных ключей для каждой подписи
- Невозможность определения, какой именно ключ создал подпись
- Периодическая ротация ключей в группе

### **Stealth-адреса для навигации**

- Генерация одноразовых ключей для каждого взаимодействия
- Использование diffie-hellman для установления безопасного канала
- Автоматическая отбраковка использованных адресов

### **7.2. Защита метаданных**

### **Анонимные DHT-запросы**

- Все запросы выглядят идентично для стороннего наблюдателя
- Использование постоянного объема данных в запросах
- Случайные задержки между запросами

### **Mix-сеть для запросов**

- Многоходовая маршрутизация через промежуточные узлы
- Шифрование на каждом шаге (луковая маршрутизация)
- Периодическая смена цепочек

### **7.3. Защита от атак**

### **Атаки на доступность**

- Rate limiting для всех операций
- Система репутации для узлов
- Автоматический бан атакующих узлов
- Резервные seed-узлы в разных сетях

### **Атаки на конфиденциальность**

- Шифрование всех передаваемых данных
- Регулярная ротация ключей
- Заполнение трафика для маскировки паттернов
- Использование Tor/I2P для особо чувствительных операций

---

## **8. Протоколы взаимодействия**

### **8.1. Bootstrap протокол**

### **Жестко запрограммированные bootstrap-узлы**

- Список из 10 надежных seed-узлов в коде клиента
- Ротация списка при каждом обновлении клиента
- Fallback на DNS-based discovery при недоступности

### **Процесс bootstrap нового узла**

1. Попытка подключения к жестко заданным seed-узлам
2. Если неудача - DNS lookup специальной SRV записи
3. Получение списка 20 случайных активных узлов
4. Построение первоначальной таблицы маршрутизации
5. Начальная синхронизация данных

### **8.2. Обмен сообщениями**

### **Публикация нового сообщения**

1. Создание и подписание сообщения
2. Определение thread_id и вычисление message_hash
3. STORE операции для:
    - Само сообщение (msg:{hash})
    - Обновление индекса треда (thread:{id}:index)
    - Обновление глобального индекса recent
4. Уведомление соседних узлов о новом контенте

### **Распространение популярного контента**

1. Seed-узлы мониторят обновления
2. При обнаружении потенциально популярного контента
3. Начинают активную репликацию на другие узлы
4. Обновление рейтингов популярности

### **8.3. Протокол поиска**

### **Поиск по релевантности**

1. Запрос к глобальному индексу популярных тредов
2. Параллельный поиск по нескольким seed-узлам
3. Ранжирование результатов на основе:
    - Популярности
    - Свежести
    - Релевантности (если доступен full-text индекс)
4. Постраничная загрузка результатов

### **Полнотекстовый поиск (опционально)**

- Индексирование на seed-узлах
- Распределенный поиск по инвертированным индексам
- Объединение результатов от нескольких индексаторов

---

## **9. Мониторинг и обслуживание**

### **9.1. Сбор статистики**

### **Метрики узла**

- Количество хранимых ключей
- Трафик входящий/исходящий
- Запросов в секунду
- Загрузка CPU и памяти
- Доступность соседних узлов

### **Метрики сети**

- Общее количество активных узлов
- Географическое распределение
- Коэффициент репликации в среднем
- Популярность различных категорий контента
- Процент потери данных

### **9.2. Механизмы самоисцеления**

### **Автоматическое восстановление данных**

- Регулярная проверка целостности хранимых данных
- Автоматическая репликация при обнаружении повреждений
- Кворумная проверка при конфликтах версий

### **Балансировка нагрузки**

- Динамическое перераспределение данных между seed-узлами
- Миграция данных с перегруженных узлов
- Автоматическое масштабирование при росте нагрузки

### **9.3. Управление seed-сетью**

### **Выбор главного seed-узла (rotating leader)**

- Ротация лидера каждые 24 часа
- Выбор на основе uptime и производительности
- Ответственность за агрегацию глобальной статистики

### **Координация репликации**

- Избегание дублирования усилий
- Распределение ответственности за категории данных
- Координация во времени для минимизации пиков нагрузки

---

## **10. Этапы развертывания**

### **Этап 1: Альфа-тестирование (2 месяца)**

- Запуск 10 seed-узлов разработчиками
- Тестирование базовой функциональности
- Отладка протоколов взаимодействия
- Набор первых 100 тестовых пользователей

### **Этап 2: Бета-тестирование (3 месяца)**

- Расширение до 50 seed-узлов (включая сообщество)
- Тестирование масштабируемости до 1000 узлов
- Оптимизация алгоритмов популярности
- Внедрение расширенных функций безопасности

### **Этап 3: Публичный запуск (постоянно)**

- Децентрализованное управление seed-сетью
- Постепенное увеличение масштаба
- Мониторинг и адаптация под реальную нагрузку
- Регулярные обновления протокола

---

## **11. Резервные механизмы и fallback**

### **11.1. Альтернативные методы discovery**

- DNS-based discovery через TXT записи
- Multicast в локальных сетях
- QR-коды для офлайн-обмена контактами
- Социальные графы (друзья рекомендуют узлы)

### **11.2. Резервное копирование критичных данных**

- Периодический экспорт глобальных индексов
- Хранение снапшотов у нескольких доверенных сторон
- Возможность восстановления сети с нуля

### **11.3. Протокол деградации**

- При потере 50% seed-узлов: переход в read-only режим
- При потере 80% seed-узлов: сохранение данных без обновлений
- Механизм экстренного восстановления из снапшотов

---

## **12. Будущие расширения**

### **12.1. Планируемые улучшения**

1. Поддержка мультимедиа контента
2. Децентрализованные платежи за хранение
3. Улучшенный полнотекстовый поиск
4. Механизмы групповой анонимности
5. Поддержка офлайн-работы с последующей синхронизацией

### **12.2. Совместимость с другими сетями**

- Шлюзы в IPFS, Dat, BitTorrent
- Поддержка ActivityPub для федерации
- Экспорт в традиционные форумы
- API для сторонних клиентов

---

## **Заключение**

Данная архитектура обеспечивает:

1. **Полную децентрализацию** через Kademlia DHT
2. **Высокую доступность** через систему seed-узлов
3. **Интеллектуальное управление данными** через механизмы популярности
4. **Анонимность** участников при публичности контента
5. **Масштабируемость** от десятков до миллионов узлов

Система предназначена для создания устойчивой, самоорганизующейся сети для анонимного обмена сообщениями, где популярный контент автоматически получает приоритет в хранении и распространении.