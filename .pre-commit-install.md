# Pre-commit Hooks - Инструкция по использованию

## Что такое pre-commit hooks?

Pre-commit hooks - это автоматические проверки, которые запускаются перед каждым коммитом. Они помогают:
- Поддерживать качество кода
- Предотвращать коммиты с ошибками форматирования
- Находить проблемы безопасности
- Обеспечивать единый стиль кода

## Установка

### 1. Установите pre-commit

```bash
# Через pip
pip install pre-commit

# Или через requirements.txt
pip install -r requirements.txt
```

### 2. Установите hooks в репозиторий

```bash
pre-commit install
```

Эта команда установит hooks в директорию `.git/hooks/`. После этого они будут автоматически запускаться при каждом `git commit`.

## Использование

### Автоматический запуск

После установки hooks запускаются автоматически при каждом коммите:

```bash
git add .
git commit -m "Your commit message"
# Pre-commit hooks запустятся автоматически
```

Если hooks найдут проблемы, коммит будет отменен, и вы увидите ошибки. Исправьте их и повторите коммит.

### Ручной запуск для всех файлов

Чтобы запустить hooks для всех файлов в репозитории:

```bash
pre-commit run --all-files
```

Это полезно при первой настройке или после обновления конфигурации hooks.

### Ручной запуск для staged файлов

Чтобы запустить hooks только для файлов, которые вы добавили в staging:

```bash
pre-commit run
```

### Запуск конкретного hook

Чтобы запустить только один конкретный hook (например, black):

```bash
pre-commit run black --all-files
```

## Что проверяют hooks

Настроенные hooks проверяют:

1. **trailing-whitespace** - удаляет пробелы в конце строк
2. **end-of-file-fixer** - добавляет пустую строку в конце файла
3. **check-yaml** - проверяет синтаксис YAML файлов
4. **check-json** - проверяет синтаксис JSON файлов
5. **check-toml** - проверяет синтаксис TOML файлов
6. **check-merge-conflict** - проверяет наличие маркеров конфликтов слияния
7. **debug-statements** - находит оставшиеся отладочные операторы (pdb, ipdb и т.д.)
8. **black** - форматирует код Python
9. **isort** - сортирует импорты
10. **flake8** - линтинг Python кода
11. **bandit** - проверка безопасности кода
12. **yamllint** - линтинг YAML файлов

## Обновление hooks

Периодически обновляйте hooks до последних версий:

```bash
pre-commit autoupdate
```

Это обновит версии всех hooks в `.pre-commit-config.yaml` до последних доступных.

## Пропуск hooks (не рекомендуется)

Если вам нужно пропустить hooks для конкретного коммита (не рекомендуется, только в исключительных случаях):

```bash
git commit --no-verify -m "Your commit message"
```

⚠️ **Внимание:** Используйте `--no-verify` только в крайних случаях. Это может привести к проблемам в CI/CD.

## Удаление hooks

Если вы хотите удалить pre-commit hooks:

```bash
pre-commit uninstall
```

## Интеграция с IDE

### VS Code

Установите расширение "Pre-commit" для автоматического запуска hooks при сохранении файлов.

### PyCharm

Настройте File Watcher для автоматического запуска pre-commit hooks.

## Решение проблем

### Hook не запускается

1. Проверьте, что hooks установлены: `pre-commit --version`
2. Переустановите hooks: `pre-commit uninstall && pre-commit install`

### Hook слишком медленный

Можно настроить hooks так, чтобы они запускались только для определенных типов файлов. Или использовать `SKIP` переменную окружения:

```bash
SKIP=flake8 git commit -m "message"
```

### Hook не находит зависимости

Убедитесь, что все зависимости установлены:

```bash
pip install -r requirements.txt
pre-commit install --install-hooks
```

## Примеры использования

### Первая настройка проекта

```bash
# 1. Установите pre-commit
pip install pre-commit

# 2. Установите hooks
pre-commit install

# 3. Запустите для всех файлов
pre-commit run --all-files

# 4. Исправьте все найденные проблемы
# 5. Зафиксируйте изменения
git add .
git commit -m "Setup pre-commit hooks"
```

### Работа с кодом

```bash
# 1. Сделайте изменения
vim rhizome/node/base_node.py

# 2. Добавьте в staging
git add rhizome/node/base_node.py

# 3. Коммит (hooks запустятся автоматически)
git commit -m "Fix node initialization"
# Если есть ошибки форматирования, hooks их исправят
# и попросят вас добавить исправления и повторить коммит

# 4. Добавьте исправления
git add rhizome/node/base_node.py
git commit -m "Fix node initialization"
```

### Обновление hooks

```bash
# Обновите до последних версий
pre-commit autoupdate

# Проверьте изменения в .pre-commit-config.yaml
git diff .pre-commit-config.yaml

# Если всё хорошо, закоммитьте обновления
git add .pre-commit-config.yaml
git commit -m "Update pre-commit hooks"
```

## Полезные команды

```bash
# Проверить версию
pre-commit --version

# Показать список установленных hooks
pre-commit run --all-files --verbose

# Очистить кэш pre-commit
pre-commit clean

# Показать текущую конфигурацию
cat .pre-commit-config.yaml
```

## Дополнительные ресурсы

- [Официальная документация pre-commit](https://pre-commit.com/)
- [Список доступных hooks](https://pre-commit.com/hooks.html)
- [Настройка для командной разработки](https://pre-commit.com/#pre-commit-for-project-maintainers)

