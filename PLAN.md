# План работ: Rhizome P2P Сеть на Kademlia DHT

## Обзор проекта

Проект представляет собой децентрализованную анонимную P2P сеть для обмена сообщениями на базе Kademlia DHT с системой seed-узлов, механизмом определения популярности контента и автоматической репликацией данных.

---

## Этап 1: Базовая инфраструктура (2-3 недели)

### 1.1. Настройка проекта
- [x] Создание структуры проекта
- [x] Настройка виртуального окружения
- [x] Настройка CI/CD
- [x] Настройка линтеров и форматтеров (black, flake8, mypy)
- [x] Настройка тестирования (pytest)

### 1.2. Базовая архитектура
- [x] Создание модуля конфигурации (`config.py`)
- [x] Создание системы логирования
- [x] Создание базовых исключений и ошибок
- [x] Создание утилит для работы с хэшами и криптографией

---

## Этап 2: Реализация Kademlia DHT (3-4 недели)

### 2.1. Базовые компоненты DHT
- [x] Реализация Node ID (160-битный идентификатор)
- [x] Реализация XOR-метрики для вычисления расстояния
- [x] Реализация k-бакетов (160 бакетов, k=20)
- [x] Реализация таблицы маршрутизации

### 2.2. Основные операции DHT
- [x] Реализация PING операции
- [x] Реализация FIND_NODE операции
- [x] Реализация FIND_VALUE операции
- [x] Реализация STORE операции
- [x] Реализация lookup алгоритма (параллельные запросы к α=3 узлам)

### 2.3. Механизмы обеспечения живучести
- [x] Реализация рефрешинга бакетов
- [x] Реализация механизма репликации
- [x] Реализация TTL и expiration для данных
- [x] Реализация автоматического продления TTL

---

## Этап 3: Система узлов (2-3 недели)

### 3.1. Базовый класс узла
- [x] Создание базового класса Node
- [x] Реализация генерации Node ID при первом запуске
- [x] Реализация сохранения/загрузки состояния узла
- [x] Реализация сетевого протокола (UDP/TCP)

### 3.2. Типы узлов
- [x] Реализация Seed-узла (высокая доступность, большой объем диска)
- [x] Реализация Full-узла (основная рабочая нагрузка)
- [x] Реализация Light-узла (ограниченные ресурсы)
- [x] Реализация Mobile-узла (максимально легкий клиент)

### 3.3. Протокол определения типа узла
- [x] Автоматическая классификация при запуске
- [x] Ручное назначение типа узла
- [ ] Динамическое изменение типа
- [ ] Верификация seed-узлов через proof-of-storage

---

## Этап 4: Система хранения данных (2-3 недели)

### 4.1. Структура ключей DHT
- [x] Реализация глобальных индексов (threads, popular, recent, seeds)
- [x] Реализация данных тредов (meta, index, popular, stats)
- [x] Реализация сообщений (msg, refs, votes)
- [ ] Реализация пользовательских данных (profile, threads, reputation)

### 4.2. Форматы данных
- [x] Реализация сериализации/десериализации (JSON/MessagePack)
- [x] Реализация метаданных треда
- [x] Реализация структуры сообщения
- [ ] Реализация валидации данных

### 4.3. Политики хранения
- [x] Реализация TTL по умолчанию (популярные, активные, обычные, личные)
- [x] Реализация продления TTL при активности
- [ ] Реализация эвакуации данных при нехватке места
- [x] Реализация минимального гарантированного срока хранения

---

## Этап 5: Механизм определения популярности (2-3 недели)

### 5.1. Метрики популярности
- [ ] Реализация базовых метрик (request_rate, replication_count, freshness, audience_size)
- [ ] Реализация расширенных метрик (social_engagements, view_time, geo_distribution, seed_coverage)
- [ ] Реализация сбора метрик на каждом узле

### 5.2. Алгоритм подсчета рейтинга
- [ ] Реализация формулы популярности с весами
- [ ] Реализация адаптивных весов (в зависимости от возраста контента)
- [ ] Реализация локального ранжирования (каждый узел)
- [ ] Реализация глобального ранжирования (seed-узлы)

### 5.3. Система голосования и спам-фильтрация
- [ ] Реализация Sybil-устойчивого голосования
- [ ] Реализация системы репутации узлов
- [ ] Реализация анти-спам механизмов (rate limiting, паттерн-анализ)
- [ ] Реализация системы жалоб и модерации

---

## Этап 6: Система seed-узлов и репликации (3-4 недели)

### 6.1. Инициализация seed-узла
- [ ] Реализация проверки требований к seed-узлу (uptime, storage, bandwidth)
- [ ] Реализация процесса становления seed-узлом
- [ ] Реализация proof-of-resources
- [ ] Реализация верификации существующими seed-узлами

### 6.2. Механизмы репликации
- [x] Реализация пассивной репликации (реактивной)
- [x] Реализация активной репликации (проактивной)
- [x] Реализация экстренной репликации
- [ ] Реализация стратегий размещения данных (географическое распределение)

### 6.3. Протокол синхронизации
- [ ] Реализация полной синхронизации для новых узлов
- [ ] Реализация инкрементальной синхронизации
- [ ] Реализация Partial Sync для light-узлов
- [ ] Реализация верификации целостности через хэши

---

## Этап 7: Анонимность и безопасность (3-4 недели)

### 7.1. Сокрытие отправителя/получателя
- [ ] Реализация кольцевых подписей для сообщений
- [ ] Реализация stealth-адресов для навигации
- [ ] Реализация ротации ключей
- [ ] Интеграция с криптографическими библиотеками

### 7.2. Защита метаданных
- [ ] Реализация анонимных DHT-запросов
- [ ] Реализация mix-сети для запросов (луковая маршрутизация)
- [ ] Реализация заполнения трафика для маскировки паттернов
- [ ] Опциональная интеграция с Tor/I2P

### 7.3. Защита от атак
- [x] Реализация rate limiting для всех операций
- [ ] Реализация системы репутации для узлов
- [ ] Реализация автоматического бана атакующих узлов
- [ ] Реализация шифрования всех передаваемых данных

---

## Этап 8: Протоколы взаимодействия (2-3 недели)

### 8.1. Bootstrap протокол
- [x] Реализация жестко запрограммированных bootstrap-узлов
- [ ] Реализация DNS-based discovery
- [x] Реализация процесса bootstrap нового узла
- [x] Реализация построения первоначальной таблицы маршрутизации

### 8.2. Обмен сообщениями
- [x] Реализация публикации нового сообщения
- [x] Реализация распространения популярного контента
- [x] Реализация уведомления соседних узлов
- [x] Реализация обновления индексов

### 8.3. Протокол поиска
- [ ] Реализация поиска по релевантности
- [ ] Реализация ранжирования результатов
- [ ] Реализация постраничной загрузки
- [ ] Реализация полнотекстового поиска (опционально)

---

## Этап 9: Мониторинг и обслуживание (2 недели)

### 9.1. Сбор статистики
- [ ] Реализация метрик узла (хранимые ключи, трафик, запросы, ресурсы)
- [ ] Реализация метрик сети (активные узлы, география, репликация)
- [ ] Реализация экспорта метрик (Prometheus, JSON)
- [ ] Реализация дашборда для мониторинга

### 9.2. Механизмы самоисцеления
- [ ] Реализация проверки целостности хранимых данных
- [ ] Реализация автоматической репликации при повреждениях
- [ ] Реализация кворумной проверки при конфликтах версий
- [ ] Реализация балансировки нагрузки

### 9.3. Управление seed-сетью
- [ ] Реализация выбора главного seed-узла (rotating leader)
- [ ] Реализация координации репликации
- [ ] Реализация распределения ответственности за категории данных

---

## Этап 10: Резервные механизмы (1-2 недели)

### 10.1. Альтернативные методы discovery
- [ ] Реализация DNS-based discovery через TXT записи
- [ ] Реализация Multicast в локальных сетях
- [ ] Реализация QR-кодов для офлайн-обмена
- [ ] Реализация социальных графов для рекомендаций узлов

### 10.2. Резервное копирование
- [ ] Реализация периодического экспорта глобальных индексов
- [ ] Реализация хранения снапшотов
- [ ] Реализация механизма восстановления сети

### 10.3. Протокол деградации
- [ ] Реализация read-only режима при потере seed-узлов
- [ ] Реализация сохранения данных без обновлений
- [ ] Реализация экстренного восстановления из снапшотов

---

## Этап 11: Тестирование и оптимизация (2-3 недели)

### 11.1. Модульное тестирование
- [ ] Покрытие тестами всех основных модулей
- [ ] Тестирование операций DHT
- [ ] Тестирование системы хранения
- [ ] Тестирование механизма популярности

### 11.2. Интеграционное тестирование
- [ ] Тестирование взаимодействия узлов
- [ ] Тестирование репликации
- [ ] Тестирование bootstrap процесса
- [ ] Тестирование синхронизации

### 11.3. Нагрузочное тестирование
- [ ] Тестирование масштабируемости (100, 1000, 10000 узлов)
- [ ] Тестирование производительности операций
- [ ] Тестирование отказоустойчивости
- [ ] Оптимизация узких мест

---

## Этап 12: Документация и развертывание (1-2 недели)

### 12.1. Документация
- [ ] API документация (Sphinx)
- [x] Руководство пользователя
- [x] Руководство разработчика
- [x] Примеры использования

### 12.2. Развертывание
- [ ] Создание Docker образов
- [x] Создание конфигурационных файлов

---

## Технологический стек

### Основные библиотеки
- **asyncio** - асинхронное программирование
- **aiohttp** или **twisted** - асинхронный сетевой протокол
- **cryptography** - криптографические операции
- **msgpack** или **protobuf** - сериализация данных
- **lmdb** или **rocksdb** - локальное хранилище ключ-значение

### Дополнительные библиотеки
- **pytest** - тестирование
- **black**, **flake8**, **mypy** - линтинг и форматирование
- **prometheus-client** - метрики
- **structlog** - структурированное логирование

---

## Оценка времени

- **Общее время разработки**: 24-32 недели (6-8 месяцев)
- **Минимальный MVP**: 12-16 недель (3-4 месяца) - этапы 1-4, 8.1-8.2
- **Альфа-версия**: 18-24 недели (4.5-6 месяцев) - все этапы кроме 10-12
- **Бета-версия**: 24-32 недели (6-8 месяцев) - все этапы

---

## Приоритеты разработки

1. **Высокий приоритет**: Этапы 1-4, 8.1-8.2 (базовая функциональность)
2. **Средний приоритет**: Этапы 5-6, 8.3, 9 (расширенная функциональность)
3. **Низкий приоритет**: Этапы 7, 10-12 (оптимизация и дополнительные функции)

---

## Риски и митигация

### Технические риски
- **Сложность реализации Kademlia DHT**: Изучение существующих реализаций, использование референсных алгоритмов
- **Производительность при масштабировании**: Раннее нагрузочное тестирование, оптимизация узких мест
- **Безопасность и анонимность**: Консультации с экспертами, аудит кода

### Организационные риски
- **Недооценка времени**: Регулярный пересмотр оценок, приоритизация задач
- **Изменение требований**: Гибкая архитектура, модульный дизайн

